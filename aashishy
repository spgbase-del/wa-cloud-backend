/**
 * WA Panel - Single File Backend
 * Node.js >= 18 (fetch built-in)
 * Express + PostgreSQL + WhatsApp Cloud API (send) + Webhooks (verify + receive)
 */

import "dotenv/config";
import express from "express";
import pg from "pg";

const { Pool } = pg;

const app = express();
app.use(express.json({ limit: "2mb" }));

// ---------- ENV ----------
const PORT = Number(process.env.PORT || 8080);
const DATABASE_URL = process.env.DATABASE_URL;

const META_ACCESS_TOKEN = process.env.META_ACCESS_TOKEN;
const WEBHOOK_VERIFY_TOKEN = process.env.WEBHOOK_VERIFY_TOKEN;

const DEFAULT_CLIENT_ID = Number(process.env.DEFAULT_CLIENT_ID || 1);
const DEFAULT_PHONE_NUMBER_DB_ID = Number(process.env.DEFAULT_PHONE_NUMBER_DB_ID || 1);

if (!DATABASE_URL) {
  console.error("❌ DATABASE_URL missing in .env");
  process.exit(1);
}

// ---------- DB ----------
const db = new Pool({ connectionString: DATABASE_URL });

// ---------- Helpers ----------
function makeDedupeKey(entry) {
  const objectId = entry?.id || "no_object";
  const change = entry?.changes?.[0];
  const value = change?.value;

  const msgId =
    value?.messages?.[0]?.id ||
    value?.statuses?.[0]?.id ||
    "no_msg";

  const ts =
    value?.messages?.[0]?.timestamp ||
    value?.statuses?.[0]?.timestamp ||
    Date.now().toString();

  return `${objectId}:${msgId}:${ts}`;
}

async function waSendText({ phoneNumberId, to, text }) {
  if (!META_ACCESS_TOKEN) throw new Error("META_ACCESS_TOKEN missing");

  const url = `https://graph.facebook.com/v20.0/${phoneNumberId}/messages`;
  const res = await fetch(url, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${META_ACCESS_TOKEN}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      messaging_product: "whatsapp",
      to,
      type: "text",
      text: { body: text },
    }),
  });

  const data = await res.json();
  if (!res.ok) {
    const err = new Error("WhatsApp send failed");
    err.details = data;
    throw err;
  }
  return data;
}

// ---------- Routes ----------
app.get("/", (_, res) => res.send("WA Panel Backend running"));

/**
 * 1) Webhook verification
 * GET /webhook/whatsapp?hub.mode=subscribe&hub.verify_token=...&hub.challenge=...
 */
app.get("/webhook/whatsapp", (req, res) => {
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  if (mode === "subscribe" && token === WEBHOOK_VERIFY_TOKEN) {
    return res.status(200).send(challenge);
  }
  return res.sendStatus(403);
});

/**
 * 2) Webhook receiver
 * POST /webhook/whatsapp
 */
app.post("/webhook/whatsapp", async (req, res) => {
  try {
    const body = req.body;

    const entry = body?.entry?.[0];
    const change = entry?.changes?.[0];
    const value = change?.value;

    const clientId = DEFAULT_CLIENT_ID;

    // Save raw event with dedupe
    const dedupeKey = makeDedupeKey(entry);
    await db.query(
      `INSERT INTO webhook_events_raw (client_id, event_type, dedupe_key, raw_json)
       VALUES ($1, $2, $3, $4)
       ON CONFLICT (dedupe_key) DO NOTHING`,
      [clientId, change?.field || "unknown", dedupeKey, body]
    );

    // A) Incoming messages
    const messages = value?.messages || [];
    for (const msg of messages) {
      const from = msg.from; // wa_id
      const text = msg?.text?.body || null;
      const wamid = msg.id;
      const phoneNumberIdFromMeta = value?.metadata?.phone_number_id;

      // find phone_number DB row by Meta phone_number_id
      const pnRow = await db.query(
        `SELECT id FROM phone_numbers
         WHERE client_id=$1 AND phone_number_id=$2
         LIMIT 1`,
        [clientId, phoneNumberIdFromMeta]
      );
      const phoneNumberDbId =
        pnRow.rows[0]?.id || DEFAULT_PHONE_NUMBER_DB_ID;

      // upsert contact
      const c = await db.query(
        `INSERT INTO contacts (client_id, wa_id, last_seen_at)
         VALUES ($1, $2, now())
         ON CONFLICT (client_id, wa_id)
         DO UPDATE SET last_seen_at=now()
         RETURNING id`,
        [clientId, from]
      );
      const contactId = c.rows[0].id;

      // upsert conversation
      const conv = await db.query(
        `INSERT INTO conversations (client_id, phone_number_id, contact_id, last_message_at)
         VALUES ($1, $2, $3, now())
         ON CONFLICT (client_id, phone_number_id, contact_id)
         DO UPDATE SET last_message_at=now()
         RETURNING id`,
        [clientId, phoneNumberDbId, contactId]
      );
      const conversationId = conv.rows[0].id;

      // insert message
      await db.query(
        `INSERT INTO messages (client_id, conversation_id, direction, type, wamid, text, payload_json, status)
         VALUES ($1, $2, 'in', $3, $4, $5, $6, 'received')`,
        [clientId, conversationId, msg.type, wamid, text, msg]
      );
    }

    // B) Status updates (sent/delivered/read/failed)
    const statuses = value?.statuses || [];
    for (const st of statuses) {
      const status = st.status;
      const msgId = st.id;

      await db.query(
        `UPDATE messages SET status=$1
         WHERE client_id=$2 AND wamid=$3`,
        [status, clientId, msgId]
      );
    }

    // Always return 200 to avoid webhook retries
    return res.sendStatus(200);
  } catch (e) {
    console.error("Webhook error:", e?.details || e);
    return res.sendStatus(200);
  }
});

/**
 * 3) Send Text API (Your internal API)
 * POST /send  { "to": "91xxxxxxxxxx", "text": "Hello" }
 */
app.post("/send", async (req, res) => {
  try {
    const clientId = DEFAULT_CLIENT_ID;
    const { to, text } = req.body;

    if (!to || !text) {
      return res.status(400).json({ error: "to और text जरूरी है" });
    }

    // get Meta phone_number_id from DB
    const pn = await db.query(
      `SELECT phone_number_id FROM phone_numbers
       WHERE id=$1 AND client_id=$2`,
      [DEFAULT_PHONE_NUMBER_DB_ID, clientId]
    );
    const metaPhoneNumberId = pn.rows[0]?.phone_number_id;
    if (!metaPhoneNumberId) {
      return res.status(500).json({ error: "phone_numbers में phone_number_id missing" });
    }

    // Ensure contact + conversation exist
    const c = await db.query(
      `INSERT INTO contacts (client_id, wa_id, last_seen_at)
       VALUES ($1, $2, now())
       ON CONFLICT (client_id, wa_id)
       DO UPDATE SET last_seen_at=now()
       RETURNING id`,
      [clientId, to]
    );
    const contactId = c.rows[0].id;

    const conv = await db.query(
      `INSERT INTO conversations (client_id, phone_number_id, contact_id, last_message_at)
       VALUES ($1, $2, $3, now())
       ON CONFLICT (client_id, phone_number_id, contact_id)
       DO UPDATE SET last_message_at=now()
       RETURNING id`,
      [clientId, DEFAULT_PHONE_NUMBER_DB_ID, contactId]
    );
    const conversationId = conv.rows[0].id;

    // Insert queued message
    const m = await db.query(
      `INSERT INTO messages (client_id, conversation_id, direction, type, text, status, payload_json)
       VALUES ($1, $2, 'out', 'text', $3, 'queued', $4)
       RETURNING id`,
      [clientId, conversationId, text, { to }]
    );
    const messageId = m.rows[0].id;

    // Send via Cloud API
    const data = await waSendText({
      phoneNumberId: metaPhoneNumberId,
      to,
      text,
    });

    const wamid = data?.messages?.[0]?.id || null;

    // Update DB
    await db.query(
      `UPDATE messages
       SET wamid=$1,
           status='sent',
           payload_json = COALESCE(payload_json, '{}'::jsonb) || $2::jsonb
       WHERE id=$3`,
      [wamid, JSON.stringify({ wa_response: data }), messageId]
    );

    return res.json({ ok: true, messageId, wamid, wa_response: data });
  } catch (e) {
    console.error("Send error:", e?.details || e);
    return res.status(500).json({ error: "send failed", details: e.details || e.message });
  }
});

/**
 * 4) Inbox
 * GET /inbox
 */
app.get("/inbox", async (req, res) => {
  const clientId = DEFAULT_CLIENT_ID;
  const rows = await db.query(
    `SELECT c.id, c.last_message_at, ct.wa_id, ct.name
     FROM conversations c
     JOIN contacts ct ON ct.id=c.contact_id
     WHERE c.client_id=$1
     ORDER BY c.last_message_at DESC
     LIMIT 50`,
    [clientId]
  );
  res.json(rows.rows);
});

/**
 * 5) Conversation messages
 * GET /conversations/:id/messages
 */
app.get("/conversations/:id/messages", async (req, res) => {
  const clientId = DEFAULT_CLIENT_ID;
  const convId = Number(req.params.id);

  const rows = await db.query(
    `SELECT id, direction, type, text, status, created_at
     FROM messages
     WHERE client_id=$1 AND conversation_id=$2
     ORDER BY created_at ASC
     LIMIT 200`,
    [clientId, convId]
  );
  res.json(rows.rows);
});

// ---------- Start ----------
app.listen(PORT, () => {
  console.log(`Server listening on :${PORT}`);
});
